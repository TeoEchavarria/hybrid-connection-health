services:
  bootstrap:
    build:
      context: .
    container_name: p2p_bootstrap
    command: >
      sh -lc '
        mkdir -p /data /shared;
        PEER_ID=$$(agent peer-id --identity-file /data/bootstrap.key);
        echo "$$PEER_ID" > /shared/bootstrap_peer_id;
        echo "[bootstrap] peer_id=$$PEER_ID, listening on 0.0.0.0:4000";
        
        # Create config with empty bootstrap peers (it is the bootstrap)
        echo "role = \"gateway\"" > /data/config.toml;
        echo "listen = \"/ip4/0.0.0.0/tcp/4000\"" >> /data/config.toml;
        echo "enable_mdns = false" >> /data/config.toml;
        echo "enable_kad = true" >> /data/config.toml;
        echo "bootstrap_peers = []" >> /data/config.toml;
        
        cd /data && exec agent --identity-file bootstrap.key run
      '
    volumes:
      - bootstrap_data:/data
      - shared:/shared
    networks:
      p2p_net:
        ipv4_address: 172.20.0.10

  client_auto1:
    build:
      context: .
    container_name: p2p_client_auto1
    command: >
      sh -lc '
        mkdir -p /data /shared;
        until [ -f /shared/bootstrap_peer_id ]; do 
          echo "[client_auto1] waiting for bootstrap peer_id..."; 
          sleep 1; 
        done;
        
        PEER_ID=$$(cat /shared/bootstrap_peer_id);
        echo "[client_auto1] Bootstrap peer ID: $$PEER_ID";
        
        # Create config with bootstrap peer
        echo "role = \"client\"" > /data/config.toml;
        echo "listen = \"/ip4/0.0.0.0/tcp/0\"" >> /data/config.toml;
        echo "enable_mdns = false" >> /data/config.toml;
        echo "enable_kad = true" >> /data/config.toml;
        echo "bootstrap_peers = [\"/ip4/172.20.0.10/tcp/4000/p2p/$$PEER_ID\"]" >> /data/config.toml;
        
        echo "[client_auto1] Starting with DHT bootstrap...";
        cd /data && exec agent --identity-file id.key run
      '
    depends_on:
      - bootstrap
    volumes:
      - client_auto1_data:/data
      - shared:/shared
    networks:
      - p2p_net

  client_auto2:
    build:
      context: .
    container_name: p2p_client_auto2
    command: >
      sh -lc '
        mkdir -p /data /shared;
        until [ -f /shared/bootstrap_peer_id ]; do 
          echo "[client_auto2] waiting for bootstrap peer_id..."; 
          sleep 1; 
        done;
        
        PEER_ID=$$(cat /shared/bootstrap_peer_id);
        echo "[client_auto2] Bootstrap peer ID: $$PEER_ID";
        
        # Create config with bootstrap peer
        echo "role = \"client\"" > /data/config.toml;
        echo "listen = \"/ip4/0.0.0.0/tcp/0\"" >> /data/config.toml;
        echo "enable_mdns = false" >> /data/config.toml;
        echo "enable_kad = true" >> /data/config.toml;
        echo "bootstrap_peers = [\"/ip4/172.20.0.10/tcp/4000/p2p/$$PEER_ID\"]" >> /data/config.toml;
        
        echo "[client_auto2] Starting with DHT bootstrap...";
        cd /data && exec agent --identity-file id.key run
      '
    depends_on:
      - bootstrap
    volumes:
      - client_auto2_data:/data
      - shared:/shared
    networks:
      - p2p_net

  # Optional: tester container for one-shot test
  tester:
    build:
      context: .
    container_name: p2p_tester
    command: >
      sh -lc '
        mkdir -p /data /shared;
        until [ -f /shared/bootstrap_peer_id ]; do 
          echo "[tester] waiting for bootstrap peer_id..."; 
          sleep 1; 
        done;
        
        PEER_ID=$$(cat /shared/bootstrap_peer_id);
        echo "[tester] Testing connection to bootstrap peer: $$PEER_ID";
        
        agent --identity-file /data/id.key test-submit \
          --dial "/ip4/172.20.0.10/tcp/4000/p2p/$$PEER_ID" \
          --timeout-secs 30
      '
    depends_on:
      - bootstrap
    volumes:
      - tester_data:/data
      - shared:/shared
    networks:
      - p2p_net
    profiles: ["test"]

networks:
  p2p_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  bootstrap_data:
  client_auto1_data:
  client_auto2_data:
  tester_data:
  shared:
